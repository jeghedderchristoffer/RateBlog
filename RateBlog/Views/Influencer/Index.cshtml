@model RateBlog.Models.InfluenterViewModels.IndexViewModel
@inject UserManager<ApplicationUser> UserManager
@inject RateBlog.Services.Interfaces.IPlatformCategoryService PlatformCategoryService
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Find en influencer";
    var user = await UserManager.GetUserAsync(User);
}


@*<div id="sortMobileModal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-content">
                <div class="modal-body">
                    <h4 style="margin-top: 0"><b>Kategorier</b></h4>

                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Lifestyle")" style="background: #fff">Lifestyle</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Beauty")" style="background: #fff">Beauty</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Fashion")" style="background: #fff">Fashion</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Gaming")" style="background: #fff">Gaming</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Entertainment")" style="background: #fff">Entertainment</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Personal")" style="background: #fff">Personal</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Interests")" style="background: #fff">Interests</label><br />

                    <h4><b>Sociale medier</b></h4>
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Facebook")" style="background: #fff">Facebook</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Instagram")" style="background: #fff">Instagram</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("YouTube")" style="background: #fff;">YouTube</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Snapchat")" style="background: #fff">Snapchat</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Twitter")" style="background: #fff">Twitter</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Twitch")" style="background: #fff;">Twitch</label><br />
                    <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Website")" style="background: #fff">Website</label><br />

                    <a class="feedback-influencer-btn width100" data-dismiss="modal">FÆRDIG</a>

                </div>
            </div>
        </div>
    </div>

    <button class="visible-xs visible-sm" id="sortMobileBtn" data-toggle="modal" data-target="#sortMobileModal"><i class="fa fa-sort" aria-hidden="true"></i></button>*@

<div style="height: 100vh; background: #fafafa">

    <div class="navbar-allaround"></div>

    <div style="background-color: #fff; height: 188px">
        <div class="outer">
            <div class="middle">
                <div class="inner">
                    <h2 style="margin-bottom: 30px; margin-top: 0">Søg på influencere</h2>
                    <form method="get" asp-area="" asp-controller="Influencer" asp-action="Index" class="form-inline">
                        <div class="input-group">
                            <input autocomplete="off" type="text" name="search" id="search" style="border: 1px solid #ddd" class="form-control search-input" list="searchSug" placeholder="F.eks. Anna, Fashion eller YouTube" />
                            <datalist id="searchSug"></datalist>
                            <div class="input-group-btn">
                                <button class="btn search-button" type="submit"><i class="fa fa-search" aria-hidden="true"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div style="padding-bottom: 50px; background: #fafafa; border-top: 1px solid #ddd">
        <div class="container" style="padding-top: 20px; padding-left: 0; padding-right: 0;">
            <div class="col-md-12 noPaddingLeft">
                <div class="col-md-3 hidden-sm hidden-xs noPaddingLeft">
                    <div class="sorter">

                        <div class="col-md-12 noPadding">
                            <h4><b>Kategorier</b></h4>

                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Lifestyle")" style="background: #fff">Lifestyle</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Beauty")" style="background: #fff">Beauty</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Fashion")" style="background: #fff">Fashion</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Gaming")" style="background: #fff">Gaming</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Entertainment")" style="background: #fff">Entertainment</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Personal")" style="background: #fff">Personal</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="kategorier" value="@PlatformCategoryService.GetCategoryIdByName("Interests")" style="background: #fff">Interests</label><br />
                        </div>
                        <div class="col-md-12 noPadding">
                            <hr />
                        </div>
                        <div class="col-md-12 noPadding">
                            <h4><b>Sociale medier</b></h4>
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Facebook")" style="background: #fff">Facebook</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Instagram")" style="background: #fff">Instagram</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("YouTube")" style="background: #fff;">YouTube</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Snapchat")" style="background: #fff">Snapchat</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Twitter")" style="background: #fff">Twitter</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Twitch")" style="background: #fff;">Twitch</label><br />
                            <label class="checkbox-inline"><input type="checkbox" name="platforme" value="@PlatformCategoryService.GetPlatformIdByName("Website")" style="background: #fff">Website</label><br />

                        </div>
                    </div>
                </div>

                <div class="col-md-9 col-sm-12 noPadding">
                    <div class="infoInfluenter">
                        <h2 style="margin-top: 0; margin-bottom: 20px;">
                            Resultater for @Model.SearchString

                            <span style="float: right;" class="hidden-xs">
                                <select id="sortBy" class="dropdown-sort">
                                    <option value="" disabled selected hidden>Sorter rating</option>
                                    <option value="1">Højeste</option>
                                    <option value="2">Laveste</option>
                                    <option value="3">Fleste</option>
                                    <option value="4">Færreste</option>
                                </select>
                            </span>

                        </h2>

                        @if (!SignInManager.IsSignedIn(User))
                        {
                            <div class="col-md-12 search-result" style="padding-top: 15px; padding-bottom: 15px; height: 150px">
                                <div class="outer">
                                    <div class="middle">
                                        <div class="inner">
                                            <h4 style="margin: 0">Bruger du sociale medier?</h4>
                                            <a data-toggle="modal" data-target="#opretModal" class="a-button center-block" style="cursor: pointer; background-color: #FFA500; float: none; letter-spacing: 1.5px; margin-top: 20px; width: 170px">Opret en profil</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="col-md-12">
                            <div style="height: 50px; margin-bottom: 30px; margin-top: 30px; display: none" id="sortLoadingBox">
                                <div class="text-center">
                                    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>


                        <div id="listOfInfluencers">
                            @Html.Partial("InfluencerListPartial", Model.InfluentList)
                        </div>

                        <div class="col-md-12 search-result" style="padding-top: 15px; padding-bottom: 15px; height: 150px; display: none" id="createInfluencer">
                            <div class="outer">
                                <div class="middle">
                                    <div class="inner">
                                        <h4 style="margin: 0">Mangler vi din influencer?</h4>
                                        <a asp-controller="Influencer" asp-action="Create" class="a-button center-block" style="background-color: #FFA500; float: none; letter-spacing: 1.5px; margin-top: 20px; width: 200px">Opret din influencer</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 text-center" id="loadingBox" style="height: 50px; display: none">
                            <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


@section Scripts{
    <script>

        var pageSize = 10;
        var pageIndex = 0;
        var searchString = "@Model.SearchString";
        var currentUsersArray;
        var ajaxDone = 0;
        var loadingComplete = false;

        $(document).ready(function () {
            // Gets the data first
            GetData();
        });


        $(window).scroll(function () {
            if (ajaxDone === 0) {
                if ($(window).scrollTop() + $(window).height() + 100 > $(document).height()) {
                    GetData();
                }
            }
        });

        // Får data når der bliver scrollet ned til bunden
        function GetData() {

            // Platform og kategori Array skal sendes med, så der kun loades ind, hvad der er sorteret efter. //
            var platformArray = new Array();
            var kategoriArray = new Array();

            $("input[type='checkbox'][name='platforme']").each(function () {
                if ($(this).is(":checked")) {
                    platformArray.push($(this).attr("value"));
                }
            });

            $("input[type='checkbox'][name='kategorier']").each(function () {
                if ($(this).is(":checked")) {
                    kategoriArray.push($(this).attr("value"));
                }
            });

            // Samler platforme og kategorier som JSON //
            var jsonPlatformArray = {};
            var jsonKategoriArray = {};

            for (i in kategoriArray) {
                jsonKategoriArray[i] = kategoriArray[i];
            }

            for (i in platformArray) {
                jsonPlatformArray[i] = platformArray[i];
            }

            // Gets the current users, so i can make sure they dont appear twice in list...
            var currentInfluencers = UpdateCurrentUserList();

            var lastInfluencer = currentInfluencers[currentInfluencers.length - 1];

            var sortBy = $("#sortBy").val();

            $.ajax({
                type: "GET",
                async: true,
                url: '/Influencer/GetNextFromList',
                beforeSend: function () {
                    ajaxDone++;
                    if (!loadingComplete) {
                        $("#loadingBox").css("display", "block");
                    }
                },
                data: {
                    pageIndex: pageIndex,
                    pageSize: pageSize,
                    search: searchString,
                    platforme: jsonPlatformArray,
                    kategorier: jsonKategoriArray,
                    lastUser: lastInfluencer,
                    sortBy: sortBy
                },
                error: function (request, error) {
                    ajaxDone--;
                },
                success: function (response) {
                    ajaxDone--;
                    if (response.trim()) {
                        $("#listOfInfluencers").append(response);
                        pageIndex++;
                        currentUsersArray = UpdateCurrentUserList();
                    }
                    else {
                        loadingComplete = true;
                        $("#createInfluencer").css("display", "block");
                    }
                },
                complete: function () {
                        $("#loadingBox").css("display", "none");
                }
            });
        };

        function Sort() {
            var platformArray = new Array();
            var kategoriArray = new Array();

            $("input[type='checkbox'][name='platforme']").each(function () {
                if ($(this).is(":checked")) {
                    platformArray.push($(this).attr("value"));
                }
            });

            $("input[type='checkbox'][name='kategorier']").each(function () {
                if ($(this).is(":checked")) {
                    kategoriArray.push($(this).attr("value"));
                }
            });

            var jsonPlatformArray = {};
            var jsonKategoriArray = {};

            for (i in kategoriArray) {
                jsonKategoriArray[i] = kategoriArray[i];
            }

            for (i in platformArray) {
                jsonPlatformArray[i] = platformArray[i];
            }

            var sortBy = $("#sortBy").val();

            // Get ajax
            $.ajax({
                type: "GET",
                async: true,
                url: '/Influencer/Sorter',
                beforeSend: function () {
                    $("#sortLoadingBox").css("display", "block");
                },
                data: {
                    platforme: jsonPlatformArray,
                    kategorier: jsonKategoriArray,
                    pageIndex: pageIndex,
                    pageSize: pageSize,
                    search: searchString,
                    sortBy: sortBy
                },
                error: function (request, error) {

                },
                success: function (response) {
                    $("#listOfInfluencers").html(response);
                },
                complete: function () {
                    $("#sortLoadingBox").css("display", "none");
                }
            });
        }

        function UpdateCurrentUserList() {
            var currentUsersArray = new Array();

            $("input[type='hidden'][name='currentInfluencers']").each(function () {
                currentUsersArray.push($(this).attr("value"));
            });
            return currentUsersArray;
        }

        $(document).ready(function () {

            currentUsersArray = UpdateCurrentUserList();

            $("input[type='checkbox'][name='platforme'], input[type='checkbox'][name='kategorier']").click(function () {
                Sort();
            });

            $('#sortBy').on('change', function () {
                Sort();
            });

        });

    </script>
}